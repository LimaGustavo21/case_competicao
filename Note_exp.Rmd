---
title: "Exploratório Indicadores"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
```{r}
#Bibliotecas
library(dplyr)
library(tidyr)
library(ggplot2)
```

## Leitura Bases

```{r}

country_series <- read.csv('WDIcountry-series.csv', header = TRUE, stringsAsFactors = FALSE)

country <- read.csv('WDICountry.csv', header = TRUE, stringsAsFactors = FALSE)

csv <- read.csv('WDICSV.csv', header = TRUE, stringsAsFactors = FALSE)

footnote <- read.csv('WDIfootnote.csv', header = TRUE, stringsAsFactors = FALSE)

series_time <- read.csv('WDIseries-time.csv', header = TRUE, stringsAsFactors = FALSE)

series <- read.csv('WDIseries.csv', header = TRUE, stringsAsFactors = FALSE)
```


### Base - Country_series

<br>

#### Relaciona países e séries (indicadores disponíveis por país)

```{r}
head(country_series)
```

```{r}
  country %>%
  group_by(Topic) %>%
  summarise(total_indicators = n()) %>%
  arrange(desc(total_indicators))
```

### Base - Country

<br>

#### Lista de países e regiões, com metadados (códigos ISO, grupos de renda, região, etc.)


```{r}
head(country)
```

### Base - Series

<br>

#### Lista de indicadores, com nomes, unidades de medida e descrições

```{r}
head(series)
```
### Base - Series-time

<br>

#### Dados de tempo por indicador, geralmente organizados em painel (country × year × value)

```{r}
head(series_time)
```
### Base - Footnote

<br>

#### Notas de rodapé explicando exceções e observações nos indicadores

```{r}
head(footnote)
```

### Base - WDICSV

<br>

#### A base principal de valores (indicador × país × ano × valor)

```{r}
head(csv)
```
```{r}
names(series)
```

--------------------------------------------------------------------------------------------

## Explorando indicadores relacionados à saúde

```{r}
  series %>%
  group_by(Topic) %>%
  summarise(total_indicators = n()) %>%
  arrange(desc(total_indicators))

```

### Identificando os tópicos que contém "Health" no nome

```{r}
series %>%
  group_by(Topic) %>%
  summarise(total_indicators = n()) %>%
  arrange(desc(total_indicators)) %>%
  filter(grepl("health", Topic, ignore.case = TRUE))
```

#### Análise - "Health: Population: Structure"

```{r}
series %>%
  filter(Topic == "Health: Population: Structure") %>%
  select(Indicator.Name, everything())
```
#### Análise - "Health: Mortality"

```{r}
series %>%
  filter(Topic == "Health: Mortality") %>%
  select(Indicator.Name, everything())
```
#### Análise - "Health: Risk factors"

```{r}
series %>%
  filter(Topic == "Health: Risk factors") %>%
  select(Indicator.Name, everything())
```



#### Análise - "Health: Nutrition"

```{r}
series %>%
  filter(Topic == "Health: Nutrition") %>%
  select(Indicator.Name, everything())
```



#### Análise - "Health: Disease prevention"

```{r}
series %>%
  filter(Topic == "Health: Disease prevention") %>%
  select(Indicator.Name, everything())
```


```{r}
targets <- c(
  "Population ages 0-14 (% of total population)",
  "Population ages 65 and above (% of total population)",
  "Mortality rate, under-5 (per 1,000 live births)",
  "Life expectancy at birth, total (years)",
  "Prevalence of anemia among children (% of children ages 6-59 months)",
  "Prevalence of overweight, weight for height (% of children under 5)",
  "Prevalence of stunting, height for age (% of children under 5)",
  "Immunization, DPT (% of children ages 12-23 months)",
  "People using safely managed drinking water services (% of population)",
  "Prevalence of HIV, total (% of population ages 15-49)"
)

series %>%
  filter(`Indicator.Name` %in% targets)
```
| Indicator.Name | Description |
|----------------|------------|
| Population ages 0-14 (% of total population) | Proporção da população com idades entre 0 e 14 anos em relação ao total da população. Indica a estrutura etária jovem do país/região. |
| Population ages 65 and above (% of total population) | Proporção da população com 65 anos ou mais em relação ao total. Indica o envelhecimento da população. |
| Mortality rate, under-5 (per 1,000 live births) | Número de crianças que morrem antes de completar 5 anos por mil nascidos vivos. É um indicador chave de saúde infantil e desenvolvimento social. |
| Life expectancy at birth, total (years) | Expectativa de vida ao nascer, considerando toda a população. Indica a saúde geral e condições de vida da população. |
| Prevalence of anemia among children (% of children ages 6-59 months) | Percentual de crianças de 6 a 59 meses que apresentam anemia. Reflete problemas nutricionais e de saúde infantil. |
| Prevalence of overweight, weight for height (% of children under 5) | Percentual de crianças menores de 5 anos com excesso de peso em relação à altura. Indicador de obesidade infantil e padrões nutricionais. |
| Prevalence of stunting, height for age (% of children under 5) | Percentual de crianças menores de 5 anos com baixa estatura para a idade (stunting). Indica desnutrição crônica. |
| Immunization, DPT (% of children ages 12-23 months) | Percentual de crianças de 12 a 23 meses vacinadas contra Difteria, Tétano e Coqueluche. Mede cobertura de vacinação infantil. |
| People using safely managed drinking water services (% of population) | Percentual da população com acesso a serviços de água potável gerenciados de forma segura. Indicador de saneamento básico e risco sanitário. |
| Prevalence of HIV, total (% of population ages 15-49) | Percentual da população de 15 a 49 anos vivendo com HIV. Indica carga da doença e riscos de saúde pública. |


```{r}
csv %>%
  filter(grepl("SH.DYN.MORT", Indicator.Code))
```


```{r}
missing_by_indicator <- function(indicator_code, start_year = 2010) {
  
  # Filtrar pelo indicador
  csv_filtered <- csv %>%
    filter(Indicator.Code == indicator_code) 
  
  # Pivotar para formato longo e filtrar anos
  csv_long <- csv_filtered %>%
    pivot_longer(
      cols = starts_with("X"),
      names_to = "Year",
      values_to = "Value"
    ) %>%
    mutate(Year = as.integer(sub("X", "", Year))) %>%
    filter(Year >= start_year)
  
  # Calcular % de missing por ano
  missing_percent <- csv_long %>%
    group_by(Year) %>%
    summarise(
      missing_count = sum(is.na(Value)),
      total_count = n(),
      missing_percent = (missing_count / total_count) * 100
    )
  
  return(missing_percent)
}


boxplot_indicator <- function(indicator_code, start_year = 2010) {
  
  # Filtrar pelo indicador
  csv_filtered <- csv %>%
    filter(Indicator.Code == indicator_code) 
  
  # Pivotar para formato longo e filtrar anos
  csv_long <- csv_filtered %>%
    pivot_longer(
      cols = starts_with("X"),
      names_to = "Year",
      values_to = "Value"
    ) %>%
    mutate(Year = as.integer(sub("X", "", Year))) %>%
    filter(Year >= start_year)
  
  # Criar o boxplot
  p <- ggplot(csv_long, aes(x = factor(Year), y = Value)) +
    geom_boxplot(fill = "skyblue", color = "darkblue") +
    labs(
      title = paste("Distribuição do Indicador", indicator_code, "por Ano"),
      x = "Ano",
      y = "Valor do Indicador"
    ) +
    theme_minimal()
  
  return(p)
}


```

#### Exploratório Variável - Expectativa de Vida

```{r}
missing_by_indicator("SP.DYN.LE00.IN", 2010)
```
```{r}
boxplot_indicator("SP.DYN.LE00.IN", 2010)
```



#### Exploratório Variável - Mortalidade infantil "SH.DYN.MORT"

```{r}
missing_by_indicator("SH.DYN.MORT", 2010)
```
```{r}
boxplot_indicator("SH.DYN.MORT", 2010)
```
```{r}
csv %>%
  filter(Indicator.Code == "SH.DYN.MORT") %>%  # Filtra exatamente pelo código
  pivot_longer(
    cols = starts_with("X"),      # Transformar anos em formato longo
    names_to = "Year",
    values_to = "Value"
  ) %>%
  filter(is.na(Value), Year == "X2022")
```
#### Exploratório Variável - % de pessoas com saneamento basico  "SH.STA.BASS.ZS"


```{r}
missing_by_indicator("SH.STA.BASS.ZS", 2010)
```
```{r}
boxplot_indicator("SH.STA.BASS.ZS", 2010)
```
```{r}
csv %>%
  filter(Indicator.Code == "SH.STA.BASS.ZS") %>%  # Filtra exatamente pelo código
  pivot_longer(
    cols = starts_with("X"),      # Transformar anos em formato longo
    names_to = "Year",
    values_to = "Value"
  ) %>%
  filter(is.na(Value), Year == "X2022")
```
#### Exploratório Variável - Percentual da população com acesso a água potável segura  "SH.H2O.BASW.ZS"


```{r}
missing_by_indicator("SH.H2O.BASW.ZS", 2010)
```
```{r}
boxplot_indicator('SH.H2O.BASW.ZS')
```
```{r}
csv %>%
  filter(Indicator.Code == "SH.H2O.BASW.ZS") %>%  # Filtra exatamente pelo código
  pivot_longer(
    cols = starts_with("X"),      # Transformar anos em formato longo
    names_to = "Year",
    values_to = "Value"
  ) %>%
  filter(is.na(Value), Year == "X2022")
```

-------------------------------------------------------------------------------------
## Tratamento dos dados

```{r}
head(country)
```
```{r}
csv_pivot = csv %>% # 
  pivot_longer(
    cols = starts_with("X"),      # Transformar anos em formato longo
    names_to = "Year",
    values_to = "Value"
  ) %>%
  filter(Year == "X2022")
```
```{r}
head(csv_pivot)
```

```{r}
wide_2022 <- csv_pivot %>%
  select(Country.Code, Indicator.Code, Value) %>%
  pivot_wider(names_from = Indicator.Code, values_from = Value)

# 3. Remove colunas com todos os valores NA
wide_2022 <- wide_2022 %>%
  select(where(~!all(is.na(.))))

# 4. Calcula as correlações com SP.DYN.LE00.IN (Life Expectancy)
cor_table <- wide_2022 %>%
  select(where(is.numeric)) %>%
  cor(use = "pairwise.complete.obs") %>%
  as.data.frame() %>%
  mutate(Indicator = rownames(.)) %>%
  select(Indicator, `SP.DYN.LE00.IN`) %>%
  arrange(desc(`SP.DYN.LE00.IN`))

# 5. Exibe a tabela ordenada
print(cor_table)
```
```{r}
series %>%
  filter(Series.Code == "SH.H2O.BASW.RU.ZS")
```

```{r}
df_plot <- csv %>%
  filter(Indicator.Code %in% c("SP.DYN.LE00.IN", "SH.H2O.BASW.RU.ZS")) %>%
  select(Country.Code, Indicator.Code, X2022) %>%   # aqui usamos X2022 (não "Value")
  pivot_wider(names_from = Indicator.Code, values_from = X2022) %>%
  drop_na(`SP.DYN.LE00.IN`, `SH.H2O.BASW.RU.ZS`)

# 2️⃣ Cria o gráfico
ggplot(df_plot, aes(x = `SH.H2O.BASW.RU.ZS`, y = `SP.DYN.LE00.IN`)) +
  geom_point(alpha = 0.7, color = "#2C7BB6") +
  geom_smooth(method = "lm", se = TRUE, color = "#D7191C") +
  labs(
    x = "Crescimento de crédito ao governo (% do M3)",
    y = "Expectativa de vida ao nascer (anos)",
    title = "Relação entre Expectativa de Vida e Crédito ao Governo (2022)",
    subtitle = "Indicadores: SP.DYN.LE00.IN vs SL.EMP.TOTL.SP.MA.NE.ZS"
  ) +
  theme_minimal(base_size = 13)
```
```{r}
dados_2022 <- csv %>%
  select(Country.Name, Country.Code, Indicator.Code, X2022) %>%
  filter(!is.na(X2022))

# 2️⃣ Filtra os dois indicadores de interesse
dados_filtrados <- dados_2022 %>%
  filter(Indicator.Code %in% c("SP.DYN.LE00.IN", "SH.H2O.BASW.RU.ZS"))

# 3️⃣ Transforma os dados em formato largo
dados_largo <- dados_filtrados %>%
  pivot_wider(
    names_from = Indicator.Code,
    values_from = X2022
  ) %>%
  drop_na(SP.DYN.LE00.IN, SH.H2O.BASW.RU.ZS)

# 4️⃣ Calcula a correlação
correlacao <- cor(dados_largo$SP.DYN.LE00.IN, dados_largo$SH.H2O.BASW.RU.ZS, use = "complete.obs")
cat("Correlação entre expectativa de vida e acesso à água potável rural:", correlacao, "\n")

# 5️⃣ Cria o gráfico com reta ajustada
ggplot(dados_largo, aes(x = SH.H2O.BASW.RU.ZS, y = SP.DYN.LE00.IN)) +
  geom_point(color = "#1f77b4", alpha = 0.7, size = 2) +
  geom_smooth(method = "lm", se = TRUE, color = "#ff7f0e", linewidth = 1) +
  labs(
    title = "Correlação entre Expectativa de Vida e Acesso à Água Potável Rural (2022)",
    subtitle = paste("Coeficiente de correlação de Pearson:", round(correlacao, 3)),
    x = "Acesso à Água Potável Rural (% da população rural)",
    y = "Expectativa de Vida ao Nascer (anos)"
  ) +
  theme_minimal(base_size = 13)
```

